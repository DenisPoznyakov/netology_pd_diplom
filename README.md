# Дипломный проект Netology: Backend интернет-магазина для автоматизации закупок

## Краткое описание проекта

Backend-сервис на **Django REST Framework** для розничной сети, реализующий полный цикл закупок:

* **Покупатели**: регистрация, авторизация (Token), восстановление пароля, просмотр каталога, добавление товаров в корзину, оформление заказа с выбором адреса доставки, просмотр истории заказов.
* **Поставщики (магазины)**: импорт товаров из YAML-прайса, экспорт текущего ассортимента в YAML, включение/отключение приёма заказов, просмотр оформленных заказов (только свои товары), изменение статуса заказа (confirmed → assembled → sent).
* Дополнительно реализованы: unit-тесты (покрывают добавление в корзину, оформление заказа и смену статуса), отправка уведомлений на email (в консоль в режиме разработки), характеристика товаров через параметры.

---

## Технологии

* Django 5.2
* Django REST Framework
* PyYAML
* django-rest-passwordreset
* python-social-auth
* SQLite (по умолчанию)
* Celery + Redis (асинхронная обработка задач)

---

## Инструкция по запуску

### 1. Клонирование репозитория

```bash
git clone https://github.com/DenisPoznyakov/netology_pd_diplom.git
cd netology_pd_diplom
```

### 2. Создание и активация виртуального окружения

**Windows:**

```bash
python -m venv env
env\Scripts\activate
```

**macOS / Linux:**

```bash
python3 -m venv env
source env/bin/activate
```

### 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 4. Применение миграций

```bash
python manage.py migrate
```

### 5. (Опционально) Создание суперпользователя

```bash
python manage.py createsuperuser
```

### 6. Запуск сервера разработки

```bash
python manage.py runserver
```

Сервис будет доступен по адресу: [http://127.0.0.1:8000](http://127.0.0.1:8000)
Админка: [http://127.0.0.1:8000/admin](http://127.0.0.1:8000/admin)

---

## Основные API эндпоинты

Все эндпоинты начинаются с `/api/v1/`.
Авторизация через заголовок `Authorization: Token <токен>`.

### Общие

* `POST /user/register` — регистрация пользователя
* `POST /user/register/confirm` — подтверждение email
* `POST /user/login` — получение токена
* `POST /user/password_reset` — запрос сброса пароля
* `POST /user/password_reset/confirm` — подтверждение нового пароля
* `GET /user/details` — данные текущего пользователя

### Покупатель

* `GET /categories` — список категорий
* `GET /shops` — список магазинов
* `GET /products` — каталог товаров (с фильтрами)
* `POST /basket` — добавить товары в корзину
  Формат:

  ```json
  {"items": [{"product_info": "id", "quantity": "n"}]}
  ```
* `GET /basket` — просмотр корзины
* `DELETE /basket` — удаление товаров из корзины
* `GET /user/contact`, `POST /user/contact`, `PUT /user/contact`, `DELETE /user/contact` — управление адресами доставки
* `POST /order` — оформление заказа из корзины
  Тело:

  ```json
  {"id": "<id_корзины>", "contact": "<id_контакта>"}
  ```
* `GET /orders` — список заказов покупателя

### Поставщик (type='shop')

* `POST /partner/update` — импорт прайса из YAML
  Тело: `{"url": "ссылка_на_yaml"}` или файл
* `GET /partner/state` / `POST /partner/state` — статус приёма заказов
* `GET /partner/orders` — список оформленных заказов (только свои товары)
* `POST /partner/orders` — изменение статуса заказа
  Тело: `{"id": "<id_заказа>", "status": "confirmed|assembled|sent"}`
* `GET /partner/export` — экспорт текущего ассортимента в YAML (скачивается файл)

---

## Доработки

### Асинхронные задачи (Celery)
- Отправка email (регистрация, сброс пароля, уведомления о заказе) — асинхронно через Celery.
- Генерация миниатюр изображений товаров и аватаров пользователей — асинхронно.

### Swagger-документация
- DRF-Spectacular: http://127.0.0.1:8000/swagger/

### Ограничение частоты запросов (throttling)
- Глобальное: anon 60/h, user 300/h, login 20/h
- Тест: `test_throttling.py` — проверяет 429 после превышения лимита.

### Социальная авторизация

- Реализована возможность входа через GitHub.
- Для работы необходимо настроить переменные окружения:

```bash
SOCIAL_AUTH_GITHUB_KEY=<ваш_client_id>
SOCIAL_AUTH_GITHUB_SECRET=<ваш_client_secret>
```

### Админ-панель

- Полный контроль над пользователями, магазинами, категориями, товарами и заказами.
- Фильтры и поиск по ключевым полям, редактирование характеристик товаров и позиций заказов.

### Кэширование через Redis
- Кэшируются: категории (15 мин), магазины (10 мин), товары (2 мин)
- Улучшение: повторные запросы в 5–10 раз быстрее (TTFB с 200 мс → 20 мс)

### Загрузка изображений с асинхронными миниатюрами

- Поля: User.avatar, Product.image
- Генерируются миниатюры разных размеров (Pillow)

### Мониторинг ошибок (Sentry)
- Подключён Sentry SDK
- Тестовый эндпоинт: /sentry-debug/ — вызывает ошибку и отправляет в Sentry

## Тестирование

Проект содержит unit-тесты, покрывающие ключевые сценарии:

* Добавление товара в корзину
* Оформление заказа
* Изменение статуса заказа поставщиком
* Ограничение частоты запросов (Throttling)

Запуск тестов:

```bash
python manage.py test backend
```

---

## Автор

Позняков Денис Андреевич

Дипломный проект профессии «Python-разработчик: расширенный курс»

Netology, 2025
